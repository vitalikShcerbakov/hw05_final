============================= test session starts ==============================
platform linux -- Python 3.9.16, pytest-6.2.4, py-1.11.0, pluggy-0.13.1 -- /home/vitalik/Dev/hw05_final/venv/bin/python3.9
django: settings: yatube.settings (from ini)
rootdir: /home/vitalik/Dev/hw05_final, configfile: pytest.ini, testpaths: tests/
plugins: pythonpath-0.7.3, Faker-12.0.1, django-4.4.0
collecting ... collected 32 items

tests/test_paginator.py::TestGroupPaginatorView::test_group_paginator_view_get PASSED [  3%]
tests/test_paginator.py::TestGroupPaginatorView::test_group_paginator_not_in_context_view PASSED [  6%]
tests/test_paginator.py::TestGroupPaginatorView::test_index_paginator_not_in_view_context PASSED [  9%]
tests/test_paginator.py::TestGroupPaginatorView::test_index_paginator_view PASSED [ 12%]
tests/test_paginator.py::TestGroupPaginatorView::test_profile_paginator_view PASSED [ 15%]
tests/test_about.py::TestTemplateView::test_about_author_tech PASSED     [ 18%]
tests/test_auth_urls.py::TestAuthUrls::test_auth_urls PASSED             [ 21%]
tests/test_comment.py::TestComment::test_comment_add_view PASSED         [ 25%]
tests/test_comment.py::TestComment::test_comment_add_auth_view PASSED    [ 28%]
tests/test_create.py::TestCreateView::test_create_view_get PASSED        [ 31%]
tests/test_create.py::TestCreateView::test_create_view_post PASSED       [ 34%]
tests/test_follow.py::TestFollow::test_follow_not_auth PASSED            [ 37%]
tests/test_follow.py::TestFollow::test_follow_auth FAILED                [ 40%]
tests/test_homework.py::TestPost::test_post_create PASSED                [ 43%]
tests/test_homework.py::TestGroup::test_group_create PASSED              [ 46%]
tests/test_homework.py::TestGroupView::test_group_view PASSED            [ 50%]
tests/test_homework.py::TestCustomErrorPages::test_custom_404 PASSED     [ 53%]
tests/test_homework.py::TestCustomErrorPages::test_custom_500 PASSED     [ 56%]
tests/test_homework.py::TestCustomErrorPages::test_custom_403 PASSED     [ 59%]
tests/test_post.py::TestPostView::test_index_post_with_image PASSED      [ 62%]
tests/test_post.py::TestPostView::test_index_post_caching PASSED         [ 65%]
tests/test_post.py::TestPostView::test_post_view_get PASSED              [ 68%]
tests/test_post.py::TestPostEditView::test_post_edit_view_get PASSED     [ 71%]
tests/test_post.py::TestPostEditView::test_post_edit_view_author_get PASSED [ 75%]
tests/test_post.py::TestPostEditView::test_post_edit_view_author_post PASSED [ 78%]
tests/test_profile.py::TestProfileView::test_profile_view_get PASSED     [ 81%]
tests/test_comment.py::TestComment::test_comment_model PASSED            [ 84%]
tests/test_follow.py::TestFollow::test_follow[author] PASSED             [ 87%]
tests/test_follow.py::TestFollow::test_follow[user] PASSED               [ 90%]
tests/test_homework.py::TestPost::test_post_model PASSED                 [ 93%]
tests/test_homework.py::TestPost::test_post_admin PASSED                 [ 96%]
tests/test_homework.py::TestGroup::test_group_model PASSED               [100%]

=================================== FAILURES ===================================
_________________________ TestFollow.test_follow_auth __________________________

self = <django.db.backends.utils.CursorWrapper object at 0x7f0b3fd707c0>
sql = 'INSERT INTO "posts_follow" ("user_id", "author_id") VALUES (%s, %s)'
params = [6, 7]
ignored_wrapper_args = (False, {'connection': <django.db.backends.sqlite3.base.DatabaseWrapper object at 0x7f0b439df820>, 'cursor': <django.db.backends.utils.CursorWrapper object at 0x7f0b3fd707c0>})

    def _execute(self, sql, params, *ignored_wrapper_args):
        self.db.validate_no_broken_transaction()
        with self.db.wrap_database_errors:
            if params is None:
                return self.cursor.execute(sql)
            else:
>               return self.cursor.execute(sql, params)

venv/lib/python3.9/site-packages/django/db/backends/utils.py:84: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <django.db.backends.sqlite3.base.SQLiteCursorWrapper object at 0x7f0b406958b0>
query = 'INSERT INTO "posts_follow" ("user_id", "author_id") VALUES (?, ?)'
params = [6, 7]

    def execute(self, query, params=None):
        if params is None:
            return Database.Cursor.execute(self, query)
        query = self.convert_query(query)
>       return Database.Cursor.execute(self, query, params)
E       sqlite3.IntegrityError: UNIQUE constraint failed: posts_follow.user_id, posts_follow.author_id

venv/lib/python3.9/site-packages/django/db/backends/sqlite3/base.py:383: IntegrityError

The above exception was the direct cause of the following exception:

self = <tests.test_follow.TestFollow object at 0x7f0b40804d60>
user_client = <django.test.client.Client object at 0x7f0b4078bb50>
user = <User: TestUser>, post = <Post: Тестовый пост 1>

    @pytest.mark.django_db(transaction=True)
    def test_follow_auth(self, user_client, user, post):
        assert hasattr(user, 'follower'), (
            'Поле `user` в модели `Follow` должно при объявлении содержать '
            '`related_name="follower"'
        )
        assert user.follower.count() == 0, 'Проверьте, что правильно считается подписки'
        self.check_url(user_client, f'/profile/{post.author.username}/follow', '/profile/<username>/follow/')
        assert user.follower.count() == 0, 'Проверьте, что нельзя подписаться на самого себя'
    
        user_1 = get_user_model().objects.create_user(username='TestUser_2344')
        user_2 = get_user_model().objects.create_user(username='TestUser_73485')
    
        self.check_url(user_client, f'/profile/{user_1.username}/follow', '/profile/<username>/follow/')
        assert user.follower.count() == 1, 'Проверьте, что вы можете подписаться на пользователя'
>       self.check_url(user_client, f'/profile/{user_1.username}/follow', '/profile/<username>/follow/')

tests/test_follow.py:120: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
tests/test_follow.py:79: in check_url
    response = client.get(f'{url}/')
venv/lib/python3.9/site-packages/django/test/client.py:535: in get
    response = super().get(path, data=data, secure=secure, **extra)
venv/lib/python3.9/site-packages/django/test/client.py:345: in get
    return self.generic('GET', path, secure=secure, **{
venv/lib/python3.9/site-packages/django/test/client.py:422: in generic
    return self.request(**r)
venv/lib/python3.9/site-packages/django/test/client.py:503: in request
    raise exc_value
venv/lib/python3.9/site-packages/django/core/handlers/exception.py:34: in inner
    response = get_response(request)
venv/lib/python3.9/site-packages/django/core/handlers/base.py:115: in _get_response
    response = self.process_exception_by_middleware(e, request)
venv/lib/python3.9/site-packages/django/core/handlers/base.py:113: in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
venv/lib/python3.9/site-packages/django/contrib/auth/decorators.py:21: in _wrapped_view
    return view_func(request, *args, **kwargs)
yatube/posts/views.py:144: in profile_follow
    Follow.objects.create(user=request.user, author=author)
venv/lib/python3.9/site-packages/django/db/models/manager.py:82: in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
venv/lib/python3.9/site-packages/django/db/models/query.py:422: in create
    obj.save(force_insert=True, using=self.db)
venv/lib/python3.9/site-packages/django/db/models/base.py:743: in save
    self.save_base(using=using, force_insert=force_insert,
venv/lib/python3.9/site-packages/django/db/models/base.py:780: in save_base
    updated = self._save_table(
venv/lib/python3.9/site-packages/django/db/models/base.py:873: in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
venv/lib/python3.9/site-packages/django/db/models/base.py:910: in _do_insert
    return manager._insert([self], fields=fields, return_id=update_pk,
venv/lib/python3.9/site-packages/django/db/models/manager.py:82: in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
venv/lib/python3.9/site-packages/django/db/models/query.py:1186: in _insert
    return query.get_compiler(using=using).execute_sql(return_id)
venv/lib/python3.9/site-packages/django/db/models/sql/compiler.py:1377: in execute_sql
    cursor.execute(sql, params)
venv/lib/python3.9/site-packages/django/db/backends/utils.py:67: in execute
    return self._execute_with_wrappers(sql, params, many=False, executor=self._execute)
venv/lib/python3.9/site-packages/django/db/backends/utils.py:76: in _execute_with_wrappers
    return executor(sql, params, many, context)
venv/lib/python3.9/site-packages/django/db/backends/utils.py:84: in _execute
    return self.cursor.execute(sql, params)
venv/lib/python3.9/site-packages/django/db/utils.py:89: in __exit__
    raise dj_exc_value.with_traceback(traceback) from exc_value
venv/lib/python3.9/site-packages/django/db/backends/utils.py:84: in _execute
    return self.cursor.execute(sql, params)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <django.db.backends.sqlite3.base.SQLiteCursorWrapper object at 0x7f0b406958b0>
query = 'INSERT INTO "posts_follow" ("user_id", "author_id") VALUES (?, ?)'
params = [6, 7]

    def execute(self, query, params=None):
        if params is None:
            return Database.Cursor.execute(self, query)
        query = self.convert_query(query)
>       return Database.Cursor.execute(self, query, params)
E       django.db.utils.IntegrityError: UNIQUE constraint failed: posts_follow.user_id, posts_follow.author_id

venv/lib/python3.9/site-packages/django/db/backends/sqlite3/base.py:383: IntegrityError
------------------------------ Captured log call -------------------------------
INFO     django.request:log.py:222 OK: /profile/TestUser_2344/follow/
Traceback (most recent call last):
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/backends/utils.py", line 84, in _execute
    return self.cursor.execute(sql, params)
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/backends/sqlite3/base.py", line 383, in execute
    return Database.Cursor.execute(self, query, params)
sqlite3.IntegrityError: UNIQUE constraint failed: posts_follow.user_id, posts_follow.author_id

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/core/handlers/exception.py", line 34, in inner
    response = get_response(request)
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/core/handlers/base.py", line 115, in _get_response
    response = self.process_exception_by_middleware(e, request)
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/core/handlers/base.py", line 113, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/contrib/auth/decorators.py", line 21, in _wrapped_view
    return view_func(request, *args, **kwargs)
  File "/home/vitalik/Dev/hw05_final/yatube/posts/views.py", line 144, in profile_follow
    Follow.objects.create(user=request.user, author=author)
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/models/manager.py", line 82, in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/models/query.py", line 422, in create
    obj.save(force_insert=True, using=self.db)
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/models/base.py", line 743, in save
    self.save_base(using=using, force_insert=force_insert,
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/models/base.py", line 780, in save_base
    updated = self._save_table(
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/models/base.py", line 873, in _save_table
    result = self._do_insert(cls._base_manager, using, fields, update_pk, raw)
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/models/base.py", line 910, in _do_insert
    return manager._insert([self], fields=fields, return_id=update_pk,
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/models/manager.py", line 82, in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/models/query.py", line 1186, in _insert
    return query.get_compiler(using=using).execute_sql(return_id)
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/models/sql/compiler.py", line 1377, in execute_sql
    cursor.execute(sql, params)
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/backends/utils.py", line 67, in execute
    return self._execute_with_wrappers(sql, params, many=False, executor=self._execute)
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/backends/utils.py", line 76, in _execute_with_wrappers
    return executor(sql, params, many, context)
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/backends/utils.py", line 84, in _execute
    return self.cursor.execute(sql, params)
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/utils.py", line 89, in __exit__
    raise dj_exc_value.with_traceback(traceback) from exc_value
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/backends/utils.py", line 84, in _execute
    return self.cursor.execute(sql, params)
  File "/home/vitalik/Dev/hw05_final/venv/lib/python3.9/site-packages/django/db/backends/sqlite3/base.py", line 383, in execute
    return Database.Cursor.execute(self, query, params)
django.db.utils.IntegrityError: UNIQUE constraint failed: posts_follow.user_id, posts_follow.author_id
=========================== short test summary info ============================
FAILED tests/test_follow.py::TestFollow::test_follow_auth - django.db.utils.I...
========================= 1 failed, 31 passed in 2.37s =========================
